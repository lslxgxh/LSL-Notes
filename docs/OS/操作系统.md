# 操作系统

## 1. 概述

### 1.1 概念

操作系统是一个控制程序、资源管理器

**特点**

* 并发：计算机系统中同时存在多个运行的程序，需要OS管理和调度。
* 共享：宏观 “同时”访问 微观 互斥访问
* 虚拟：利用多道程序设计技术，让每个用户都觉得有一个计算机专门为他服务
* 异步：
  1. 程序的执行不是一贯到底的，而是走走停停，向前推进的速度不可预知
  2. 只要运行环境相同，OS需要保证程序运行的结果也要相同

### 1.2 演变

#### 1.2.1 单用户系统

#### 1.2.2 批处理系统

* 顺序执行
* 批处理

#### 1.2.3 多道程序系统

* 保持多个工作在内存中并且在各个工作间复用CPU

#### 1.2.4 分时系统

* 每一个作业计算一段时间后产生时钟中断，然后交替执行
* 时钟和CPU是独立的，时钟中断程序时这样的：在CPU执行指令时，计数器（计时器）同时在计时，当计时器溢出时，就向CPU申请中断，如果允许响应中断，CPU就转到中断服务程序执行相关的程序。

#### 1.2.5 个人电脑操作系统 

#### 1.2.6 分布式操作系统

* 网络支持成为一个重要的功能
* 通常支持分布式服务：跨多系统的数据共享与协调
* 可能使用多个处理器：松、紧耦合系统
* 高可用性与可靠性的要求

### 1.3 操作系统结构

* 简单结构
* 分层结构：最底层硬件，最高层用户界面。使用模块化，每一层仅使用更低一层的功能（操作）和服务。
* 微内核结构
  1. 大内核：大内核是将操作系统功能作为一个紧密结合的整体放到内核。由于各模块共享信息，因此有很高的性能。
  2. 微内核：由于操作系统不断复杂，因此将一部分操作系统功能移出内核，从而降低内核的复杂性。移出的部分根据分层的原则划分成若干服务，相互独立。在微内核结构下，操作系统被划分成小的、定义良好的模块，只有微内核这一个模块运行在内核态，其余模块运行在用户态。因为需要频繁地在用户态和核心态之间进行切换，所以会有一定的性能损失。

![img](https://github.com/CyC2018/CS-Notes/raw/master/notes/pics/2_14_microkernelArchitecture.jpg)

* 外核结构（硬件上只有一个安全绑定）
  1. 让内核分配机器的物理资源给多个应用程序，并让每个程序决定如何处理这些资源
  2. 程序能连接到操作系统库（libOS）实现了操作系统抽象
  3. 保护与控制分离
* VMM 虚拟机管理器 硬件——VMM——操作系统

## 2. 中断、异常和系统调用

### 2.1 BIOS

CS:IP=0xf000:fff0(CS：代码段寄存器；IP：指令指针寄存器)

系统处于实模式 PC = 16 * CS +IP

20位地址空间 1MB

BIOS启动固件：

* 将加载程序从磁盘的引导扇区（512字节）加载到0x7c00 
* 跳转到 CS：IP 0000:7c00

加载程序：

* 将操作系统的代码和数据从硬盘加载到内存中
* 跳转到操作系统的起始地址

### 2.2 系统启动流程

BIOS：系统加电，BIOS初始化硬件 ——> 主引导记录：BIOS读取主引导扇区代码 ——> 活动分区：主引导扇区代码读取活动分区的引导扇区代码 ——> 加载程序：引导扇区代码读取文件系统的加载程序

#### 2.2.1 CPU初始化

* CPU加电稳定后从0XFFFF0读第一条指令
  * CS：IP = 0xf000：fff0
  * 第一条指令是跳转指令
* CPU初始状态为16位实模式
  * CS：IP 是16位寄存器
  * 指令指针PC = 16 * CS + IP
  * 最大地址空间是1 MB

#### 2.2.2 BIOS初始化过程

* 硬件自检POST：检查状态，设备初始化
* 系统自检：检测和配置系统中安装的即插即用的设备
* 更新CMOS中的扩展系统配置数据ESCD
* 按指定位置启动

#### 2.2.3 主引导记录MBR格式

启动代码 446字节

* 检查分区表正确性
* 加载并跳转到磁盘上的引导程序

硬盘分区表

* 描述分区状态和位置
* 每个分区描述信息占据16字节

结束标志：2字节（55AA）

* 主引导记录的有效标志

#### 2.2.4 分区引导扇区格式

* 跳转指令：跳转到与平台相关的启动代码
* 文件卷头：文件系统的描述信息
* 启动代码：跳转到就爱在程序
* 结束标志：55AA

#### 2.2.5 加载程序

* 加载程序：从文件系统中读取启动配置信息
* 启动菜单：可选的操作系统内核列表和加载参数
* 操作系统内核：依据配置加载指定内核并跳转到内和执行

#### 2.2.6 系统启动规范

* BIOS
* UEFI：可信引导程序，所有平台一直启动服务

### 2.3 中断

* 外中断：由 CPU 执行指令以外的事件引起，如 I/O 完成中断，表示设备输入/输出处理已经完成，处理器能够发送下一个输入/输出请求。此外还有时钟中断、控制台中断等。
*  异常：由 CPU 执行指令的内部事件引起，如非法操作码、地址越界、算术溢出等。
* 系统调用（陷入）：在用户程序中使用系统调用。
